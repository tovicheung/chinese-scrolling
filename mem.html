<title>Chinese</title>
<meta charset="utf-8">
<link rel="stylesheet" href="style.css">

<style>
    #container {
        height: 100%;
        padding: 70px;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
    }

    #main {
        width: 100%;
        font-size: 3vh;
        font-weight: bold;
        -webkit-touch-callout: none; /* iOS Safari */
        -webkit-user-select: none; /* Safari */
        -khtml-user-select: none; /* Konqueror HTML */
        -moz-user-select: none; /* Old versions of Firefox */
        -ms-user-select: none; /* Internet Explorer/Edge */
        user-select: none;
    }

    #bar-outer {
        width: 80vw;
        height: 2vh;
        border-radius: 99px;
        margin-bottom: 30px;
        background-color: rgb(236, 98, 98);
        display: flex;
        flex-direction: row;
        justify-content: flex-start;
    }

    #bar-inner {
        height: 100%;
        border-radius: 99px;
        background-color: rgb(60, 194, 60);
    }

    .grow {
        flex-grow: 2;
    }

    input[type = range] {
        width: 70%;
        height: 3vh;
        margin: 30px;
        background-color: red;
        outline: none;
    }
</style>

<div id="modal">
    <h5>Timer:</h5>
    <div style="display: flex; flex-direction: row;">
        <input type="range" min="5" max="10" value="7" oninput="document.getElementById('secs').innerText = this.value + 's'">
        <h5 id="secs">7s</h5>
    </div>
    <br>
    <h5>Select text:</h5>
</div>

<div id="container">
    <div class="grow"></div>
    <p id="main"></p>
    <div class="grow"></div>
    <div id="bar-outer">
        <div id="bar-inner"></div>
    </div>
</div>

<script src="texts.js"></script>
<script>
    const FPS = 30;
    const MSPF = 1000 / FPS; // milliseconds per frame

    // running state
    let running = false; // will clicks reveal characters?
    let text = "";
    let index = 0; // index of the character to be revealed    
    let interval = null;
    let next_click_go_modal = false;
    
    // time in ms
    let full = 5000;
    let time = 5000;

    function start() {
        document.getElementById("main").innerHTML = "";

        running = true;
        index = 0;
        interval = setInterval(() => {
            time -= MSPF
            if (time < 0) return end();
            document.getElementById("bar-inner").style.width = `${time / full * 100}%`
        }, MSPF);
        next_click_go_modal = false;
        
        time = full = parseInt(document.getElementById("secs").innerText.replace("s", "")) * 1000;
    }

    function end() {
        running = false;
        clearInterval(interval);
        next_click_go_modal = true;

        document.getElementById("main").innerHTML += `<span class="red">${text.substr(index)}</span>`;
    }

    function update_char() {
        document.getElementById("main").innerHTML = text.substring(0, index);
    }

    function toggle_modal() {
        let modal = document.getElementById("modal");
        modal.style.display = modal.style.display == "none" || modal.style.display == "" ? "block" : "none";
    }

    addEventListener(
        window.matchMedia("(any-hover: none)").matches
            ? "touchstart" // no hovering = no mouse
            : "mousedown",
        () => {
            if (running) {
                time += 1000;
                if (time > full) time = full;
                index++;
                update_char();
                if (index > text.length) end();
            } else if (next_click_go_modal) {
                next_click_go_modal = false;
                toggle_modal();
            }
        }
    );
    
    document.addEventListener("DOMContentLoaded", () => {
        let modal = document.getElementById("modal");
        for ([key, value] of Object.entries(TEXTS)) {
            button = document.createElement("button")
            button.innerText = key;
            button.onclick = e => {
                text = TEXTS[e.target.innerText];
                toggle_modal();
                start();
            }
            modal.appendChild(button);
        }
        toggle_modal();
    });
</script>
